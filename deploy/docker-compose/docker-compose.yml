# Prism Core Services
#
# Usage:
#   Development (all services):
#     docker compose -f docker-compose.yml -f docker-compose.infra.yml -f docker-compose.observability.yml up -d
#
#   Infrastructure only:
#     docker compose -f docker-compose.infra.yml up -d
#
#   Core services only (requires infrastructure running):
#     docker compose up -d

services:
  # =============================================================================
  # Gateway Service - API Gateway / Reverse Proxy
  # =============================================================================
  gateway:
    build:
      context: ../..
      dockerfile: deploy/docker/gateway.Dockerfile
    container_name: prism-gateway
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
      - "${GATEWAY_HEALTH_PORT:-9080}:9080"
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      GATEWAY_HOST: "0.0.0.0"
      GATEWAY_PORT: "8080"
      GATEWAY_LOG_LEVEL: ${LOG_LEVEL:-debug}
      GATEWAY_LOG_FORMAT: ${LOG_FORMAT:-json}
      GATEWAY_AUTH_GRPC_ADDRESS: "auth:50051"
      GATEWAY_CONFIG_GRPC_ADDRESS: "config:50052"
      GATEWAY_RATE_LIMIT_REQUESTS_PER_SECOND: "100"
      GATEWAY_RATE_LIMIT_BURST_SIZE: "200"
      # Redis for caching
      GATEWAY_REDIS_ADDRESS: "redis:6379"
      GATEWAY_REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # NATS for events
      GATEWAY_NATS_URL: "nats://nats:4222"
      # Tracing
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4317"
      OTEL_SERVICE_NAME: "prism-gateway"
    volumes:
      - ../../configs/gateway.yaml:/etc/prism/gateway.yaml:ro
    depends_on:
      auth:
        condition: service_healthy
    networks:
      - prism-frontend
      - prism-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      service: "gateway"
    deploy:
      resources:
        limits:
          memory: 256M

  # =============================================================================
  # Auth Service - Authentication & Authorization
  # =============================================================================
  auth:
    build:
      context: ../..
      dockerfile: deploy/docker/auth.Dockerfile
    container_name: prism-auth
    ports:
      - "${AUTH_GRPC_PORT:-50051}:50051"
      - "${AUTH_HTTP_PORT:-8081}:8081"
      - "${AUTH_HEALTH_PORT:-51051}:51051"
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      AUTH_GRPC_HOST: "0.0.0.0"
      AUTH_GRPC_PORT: "50051"
      AUTH_HTTP_HOST: "0.0.0.0"
      AUTH_HTTP_PORT: "8081"
      # Database
      AUTH_DATABASE_HOST: "postgres-auth"
      AUTH_DATABASE_PORT: "5432"
      AUTH_DATABASE_USER: ${POSTGRES_AUTH_USER}
      AUTH_DATABASE_PASSWORD: ${POSTGRES_AUTH_PASSWORD}
      AUTH_DATABASE_NAME: ${POSTGRES_AUTH_DB}
      AUTH_DATABASE_SSL_MODE: "disable"
      # JWT
      AUTH_JWT_PRIVATE_KEY_PATH: "/var/lib/prism/keys/private.pem"
      AUTH_JWT_PUBLIC_KEY_PATH: "/var/lib/prism/keys/public.pem"
      AUTH_JWT_ACCESS_TOKEN_TTL: ${JWT_ACCESS_TOKEN_TTL:-15m}
      AUTH_JWT_REFRESH_TOKEN_TTL: ${JWT_REFRESH_TOKEN_TTL:-168h}
      AUTH_JWT_ISSUER: ${JWT_ISSUER:-prism}
      # Redis for sessions
      AUTH_REDIS_ADDRESS: "redis:6379"
      AUTH_REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # NATS for events
      AUTH_NATS_URL: "nats://nats:4222"
      # OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL:-http://localhost:8081/auth/google/callback}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      GITHUB_REDIRECT_URL: ${GITHUB_REDIRECT_URL:-http://localhost:8081/auth/github/callback}
      # Logging
      AUTH_LOG_LEVEL: ${LOG_LEVEL:-debug}
      AUTH_LOG_FORMAT: ${LOG_FORMAT:-json}
      # Tracing
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4317"
      OTEL_SERVICE_NAME: "prism-auth"
    volumes:
      - ../../configs/auth.yaml:/etc/prism/auth.yaml:ro
      - auth-keys:/var/lib/prism/keys
    networks:
      - prism-backend
      - prism-data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:51051/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      service: "auth"
    deploy:
      resources:
        limits:
          memory: 256M

  # =============================================================================
  # Config Service - Configuration Management
  # =============================================================================
  config:
    build:
      context: ../..
      dockerfile: deploy/docker/config.Dockerfile
    container_name: prism-config
    ports:
      - "${CONFIG_GRPC_PORT:-50052}:50052"
      - "${CONFIG_HEALTH_PORT:-51052}:51052"
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      CONFIG_GRPC_HOST: "0.0.0.0"
      CONFIG_GRPC_PORT: "50052"
      CONFIG_CONSUL_ADDRESS: "consul:8500"
      CONFIG_CONSUL_TOKEN: ${CONSUL_HTTP_TOKEN:-}
      # NATS for events
      CONFIG_NATS_URL: "nats://nats:4222"
      # Logging
      CONFIG_LOG_LEVEL: ${LOG_LEVEL:-debug}
      CONFIG_LOG_FORMAT: ${LOG_FORMAT:-json}
      # Tracing
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4317"
      OTEL_SERVICE_NAME: "prism-config"
    networks:
      - prism-backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:51052/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      service: "config"
    deploy:
      resources:
        limits:
          memory: 128M

  # =============================================================================
  # Dashboard - Web UI for Monitoring
  # =============================================================================
  dashboard:
    build:
      context: ../..
      dockerfile: web/dashboard/Dockerfile
    container_name: prism-dashboard
    ports:
      - "${DASHBOARD_PORT:-3001}:3001"
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - prism-frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      service: "dashboard"
    deploy:
      resources:
        limits:
          memory: 64M

# =============================================================================
# Networks
# =============================================================================
networks:
  prism-frontend:
    driver: bridge
    name: prism-frontend
  prism-backend:
    driver: bridge
    name: prism-backend
  prism-data:
    driver: bridge
    name: prism-data

# =============================================================================
# Volumes
# =============================================================================
volumes:
  auth-keys:
    name: prism-auth-keys
